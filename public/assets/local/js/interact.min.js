/**
 * Interact
 *
 * @version			1.0.1
 *
 * @author			Aby Dahana
 * @profile			abydahana.github.io
 *
 * Property of DWITRI Media
 * www.dwitrimedia.com
 */

var UA									= ($(window).outerWidth() < 1024 ? 'mobile' : 'desktop');

$(document).ready(function()
{
	"use strict";
	/**
	 * Button add, hide and show the element
	 */
	$('body').on('click touch', '.btn-add', function(e)
	{
		e.preventDefault(),
		$(this).toggleClass('active');
		
		if($(this).hasClass('active'))
		{
			$(this).closest('form').attr('action', $(this).closest('form').attr('data-original-action')),
			$(this).closest('form').find('.form-input').removeClass('d-none'),
			$(this).closest('form').find('textarea').height('auto'),
			$(this).closest('form').find('button[type=submit]').removeClass('d-none').attr('disabled', false),
			$(this).find('.btn-icon').removeClass('mdi-plus').addClass('mdi-window-close'),
			$(this).find('.btn-label').text(phrase.cancel)
		}
		else
		{
			$(this).closest('form').attr('action', $(this).closest('form').attr('data-original-action')),
			$(this).closest('form').find('.form-input').addClass('d-none'),
			$(this).closest('form').find('.form-input').find('select, input, textarea').val(''),
			$(this).closest('form').find('.form-input').find('input[type=checkbox]').prop('checked', false),
			$(this).closest('form').find('button[type=submit]').addClass('d-none').attr('disabled', true),
			$(this).find('.btn-icon').addClass('mdi-plus').removeClass('mdi-window-close'),
			$(this).find('.btn-label').text(phrase.add)
		}
	}),
	
	/**
	 * Update button
	 */
	$('body').on('click touch', '.btn-edit', function(e)
	{
		var _parent						= $(this).closest($(this).attr('data-parent'));
		
		e.preventDefault(),
		(_parent.find('.form-input').hasClass('d-none') ? _parent.find('.btn-add').trigger('click') : null),
		_parent.find('form').attr('action', $(this).attr('data-href')),
		_parent.find('select[name=type]').val($(this).attr('data-content-type')).trigger('change'),
		_parent.find('input[name=value]').val($(this).attr('data-content-value')),
		_parent.find('input[name=start]').val($(this).attr('data-content-start')),
		_parent.find('input[name=end]').val($(this).attr('data-content-end')),
		_parent.find('textarea[name=description]').val($(this).attr('data-content-description')).height('auto'),
		(1 == $(this).attr('data-content-present') ? _parent.find('input[name=present]').prop('checked', true) : null),
		_parent.find('input[name=position]').val($(this).attr('data-content-position')),
		_parent.find('input[name=level_achieved][value=' + $(this).attr('data-content-level-achieved') + ']').prop('checked', true),
		$('html, body').animate
		({
			/* scroll, scroll */
			scrollTop: _parent.find('form').offset().top - 60
		}, 200)
	}),
	
	/**
	 * Live submit, show the submitted data after executed
	 */
	$('body').on('submit', '.--live-submit', function(e)
	{
		e.preventDefault(),
		$.ajax
		({
			url: $(this).attr('action'),
			method: 'POST',
			context: this,
			data: new FormData(this),
			contentType: false,
			processData: false,
			beforeSend: function(progress)
			{
				$(this).find('select, input, textarea, button[type=submit]').attr('disabled', true)
			}
		})
		.done(function(response)
		{
			$(this).find('select, input, textarea, button[type=submit]').attr('disabled', false);
			
			if(200 == response.status)
			{
				$(this).find('.form-input').addClass('d-none'),
				$(this).find('select, input, textarea').val(''),
				$(this).find('input[type=checkbox]').prop('checked', false),
				$(this).find('button[type=submit]').addClass('d-none').attr('disabled', true),
				$('.btn-add').removeClass('active'),
				$('.btn-add').find('.btn-icon').addClass('mdi-plus').removeClass('mdi-window-close'),
				$('.btn-add').find('.btn-label').text(phrase.add),
				($(response.override).length ? $(response.override).remove() : null);
				
				if('contact' == response.template)
				{
					$(
						'<div class="form-group">' +
							'<div class="btn-group btn-group-sm float-right">' +
								'<button type="button" data-href="' + response.action_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 btn-edit" data-toggle="tooltip" title="' + phrase.update + '" data-parent="#v-pills-contact" data-content-type="' + response.type + '" data-content-value="' + response.value + '">' +
									'<i class="mdi mdi-square-edit-outline"></i>' +
								'</button>' +
								'<a href="' + response.delete_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 --open-delete-confirm" data-toggle="tooltip" title="' + phrase.remove + '">' +
									'<i class="mdi mdi-trash-can-outline"></i>' +
								'</a>' +
							'</div>' +
							'<label class="text-muted d-block mb-0">' +
								response.label +
							'</label>' +
							'<p class="text-word-wrap">' +
								response.value +
							'</p>' +
						'</div>'
					)
					.insertBefore($(this))
				}
				else if('education' == response.template)
				{
					$(
						'<div class="form-group">' +
							'<div class="row">' +
								'<div class="col-2 col-sm-1 pt-2">' +
									'<i class="mdi ' + (1 == response.type ? 'mdi-chair-school' : (2 == response.type ? 'mdi-school' : 'mdi-account-tie')) + ' mdi-2x text-muted"></i>' +
								'</div>' +
								'<div class="col-10 col-sm-11">' +
									'<div class="btn-group btn-group-sm float-right">' +
										'<button type="button" data-href="' + response.action_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 btn-edit" data-toggle="tooltip" title="' + phrase.update + '" data-parent="#v-pills-education" data-content-type="' + response.type + '" data-content-value="' + response.value + '" data-content-start="' + response.start + '" data-content-end="' + response.end + '" data-content-present="' + response.present + '" data-content-description="' + response.description + '">' +
											'<i class="mdi mdi-square-edit-outline"></i>' +
										'</button>' +
										'<a href="' + response.delete_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 --open-delete-confirm" data-toggle="tooltip" title="' + phrase.remove + '">' +
											'<i class="mdi mdi-trash-can-outline"></i>' +
										'</a>' +
									'</div>' +
									'<label class="d-block mb-0">' +
										phrase.went_to + ' <b>' + response.value + '</b>' +
									'</label>' +
									'<label class="text-muted d-block mb-0">' +
										response.start + ' ' + phrase.up_to + ' ' + (response.present ? phrase.present : response.end) +
									'</label>' +
									'<p class="text-sm text-word-wrap">' +
										response.description +
									'</p>' +
								'</div>' +
							'</div>' +
						'</div>'
					)
					.insertBefore($(this))
				}
				else if('workplace' == response.template)
				{
					$(
						'<div class="form-group">' +
							'<div class="row">' +
								'<div class="col-2 col-sm-1 pt-2">' +
									'<i class="mdi mdi-account-multiple-outline mdi-2x text-muted"></i>' +
								'</div>' +
								'<div class="col-10 col-sm-11">' +
									'<div class="btn-group btn-group-sm float-right">' +
										'<button type="button" data-href="' + response.action_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 btn-edit" data-toggle="tooltip" title="' + phrase.update + '" data-parent="#v-pills-working-experience" data-content-position="' + response.position + '" data-content-value="' + response.value + '" data-content-start="' + response.start + '" data-content-end="' + response.end + '" data-content-present="' + response.present + '" data-content-description="' + response.description + '">' +
											'<i class="mdi mdi-square-edit-outline"></i>' +
										'</button>' +
										'<a href="' + response.delete_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 --open-delete-confirm" data-toggle="tooltip" title="' + phrase.remove + '">' +
											'<i class="mdi mdi-trash-can-outline"></i>' +
										'</a>' +
									'</div>' +
									'<label class="d-block mb-0">' +
										phrase.position + ' ' + phrase.at + ' <b>' + response.value + '</b>' +
									'</label>' +
									'<label class="text-muted d-block mb-0">' +
										response.start + ' ' + phrase.up_to + ' ' + (response.present ? phrase.present : response.end) +
									'</label>' +
									'<p class="text-sm text-word-wrap">' +
										response.description +
									'</p>' +
								'</div>' +
							'</div>' +
						'</div>'
					)
					.insertBefore($(this))
				}
				else if('skill' == response.template)
				{
					$(
						'<div class="form-group">' +
							'<div class="row">' +
								'<div class="col-2 col-sm-1 pt-2">' +
									'<i class="mdi mdi-progress-check mdi-2x text-muted"></i>' +
								'</div>' +
								'<div class="col-10 col-sm-11">' +
									'<div class="btn-group btn-group-sm float-right">' +
										'<button type="button" data-href="' + response.action_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 btn-edit" data-toggle="tooltip" title="' + phrase.update + '" data-parent="#v-pills-professional-skills" data-content-value="' + response.value + '" data-content-description="' + response.description + '" data-content-level-achieved="' + response.level_achieved + '">' +
											'<i class="mdi mdi-square-edit-outline"></i>' +
										'</button>' +
										'<a href="' + response.delete_href + '" class="btn btn-outline-secondary btn-sm pt-0 pb-0 --open-delete-confirm" data-toggle="tooltip" title="' + phrase.remove + '">' +
											'<i class="mdi mdi-trash-can-outline"></i>' +
										'</a>' +
									'</div>' +
									'<label class="d-block mb-0">' +
										phrase.achieved + ' <b>' + response.value + '</b>' +
									'</label>' +
									'<label class="text-muted d-block mb-0">' +
										(1 == response.level_achieved ? phrase.beginner : (2 == response.level_achieved ? phrase.intermediate : (3 == response.level_achieved ? phrase.advanced : phrase.expert))) +
									'</label>' +
									'<p class="text-sm text-word-wrap">' +
										response.description +
									'</p>' +
								'</div>' +
							'</div>' +
						'</div>'
					)
					.insertBefore($(this))
				}
			}
			else if(400 == response.status)
			{
				/* form validation */
				var _focus_to			= null,
					_this				= $(this);
				
				/* loop the exception response */
				$.each(response.exception, function(key, val)
				{
					/* get the upper field that will be used to scroll to, skip when found the upper */
					if(!_focus_to)
					{
						_focus_to		= '#' + key + '_input';
					}
					
					/* add the highlight class to the field */
					_this.find('#' + key + '_input').addClass('is-invalid'),
					
					/* append the callback messages to field */
					$('<div class="invalid-feedback d-block">' + val + '</div>').appendTo($('#' + key + '_input').closest('.form-group'))
				}),
				
				/* scroll to the first error field */
				$($(_this.closest('.modal:visible').length ? '.modal' : 'html, body'))
				.animate
				({
					/* scroll, scroll */
					scrollTop: ($(_focus_to).length ? $(_focus_to).offset().top : 0)
				}, 200)
			}
			else
			{
				return throw_exception(response.status, response.exception)
			}
		})
	})
});